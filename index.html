<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Calorie Tracker (LocalStorage)</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/JhYCyOE.png"> <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .progress-bar-bg { background-color: #e0e0e0; }
        .progress-bar {
            transition: width 0.3s ease-in-out;
            text-align: center;
            color: white;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
        }
        .nav-button, .cal-view-btn, .cal-nav-btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content { max-width: 90%; }
        @media (min-width: 640px) { .modal-content { max-width: 500px; } }

        /* Calendar Styles */
        .calendar-day-cell {
            border: 1px solid #e2e8f0; /* gray-300 */
            padding: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .calendar-month-view .calendar-day-cell {
             min-height: 90px; /* For month view cells */
        }
        .calendar-week-view .calendar-day-cell {
            min-height: 60px; /* For week view list items */
            margin-bottom: 2px; /* Add some space between days in week view */
        }
        .calendar-day-cell:hover {
            background-color: #f0f4f8; /* lighter indigo/blue */
        }
        .calendar-day-cell.other-month {
            background-color: #f7fafc; /* gray-100 */
            color: #a0aec0; /* gray-500 */
        }
        .calendar-day-cell.is-today {
            background-color: #ebf4ff; /* blue-100 */
            border: 1px solid #90cdf4; /* blue-300 */
        }
        .calendar-day-cell.is-current-dashboard-date {
            box-shadow: inset 0 0 0 2px #667eea; /* indigo-500 */
        }
        .calendar-day-header-label { /* For Sun-Sat labels */
            font-weight: 600;
            color: #4a5568; /* gray-700 */
            padding-bottom: 4px;
        }
        .cal-data { font-size: 0.75rem; margin-top: 2px; }
        .cal-data-value { font-weight: 500; }
        .cal-data-cal { color: #38a169; /* green-600 */ }
        .cal-data-prot { color: #3182ce; /* blue-600 */ }
        .cal-data-fib { color: #dd6b20; /* orange-600 */ }

        /* Week view specific cell content styling */
        .week-view-cell-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .week-view-day-info {
            font-weight: 500;
        }
        .week-view-stats {
            text-align: right;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div>
        <p class="ml-4 text-white text-lg">Processing...</p>
    </div>

    <div id="messageModal" class="fixed inset-0 modal-overlay flex items-center justify-center z-50 hidden">
        <div class="modal-content bg-white p-6 rounded-lg shadow-xl">
            <p id="messageText" class="text-gray-700 mb-4"></p>
            <button id="messageOkButton" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">OK</button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-indigo-700">Daily Calorie Tracker</h1>
            <p class="text-sm text-gray-500 mt-1">Data saved locally in your browser.</p>
        </header>

        <nav class="mb-8 flex justify-center space-x-2 md:space-x-4">
            <button id="viewDashboardButton" class="nav-button py-2 px-3 md:px-6 rounded-md font-semibold">Dashboard</button>
            <button id="viewCalendarButton" class="nav-button py-2 px-3 md:px-6 rounded-md font-semibold bg-gray-200 text-gray-700">Calendar</button>
            <button id="viewSettingsButton" class="nav-button py-2 px-3 md:px-6 rounded-md font-semibold bg-gray-200 text-gray-700">Settings</button>
        </nav>

        <main id="dashboardView" class="space-y-8">
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h2 id="currentDateDisplay" class="text-2xl font-semibold mb-4 text-indigo-600">Displaying: ...</h2>
                <form id="foodForm" class="space-y-4">
                    <div><label for="foodName" class="block text-sm font-medium text-gray-700">Food Item</label><input type="text" id="foodName" name="foodName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label for="calories" class="block text-sm font-medium text-gray-700">Calories (kcal)</label><input type="number" id="calories" name="calories" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                        <div><label for="protein" class="block text-sm font-medium text-gray-700">Protein (g)</label><input type="number" id="protein" name="protein" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                        <div><label for="fiber" class="block text-sm font-medium text-gray-700">Fiber (g)</label><input type="number" id="fiber" name="fiber" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Add Food Item to <span id="addFoodButtonDate">Current Day</span></button>
                </form>
            </section>
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-indigo-600">Progress for <span id="progressDateDisplay">...</span></h3>
                <div class="space-y-4"> <div>
                        <div class="flex justify-between text-sm font-medium text-gray-700 mb-1">
                            <span>Calories</span>
                            <span>Consumed: <span id="totalCalories" class="font-semibold">0</span> / <span id="calorieGoalDisplay" class="font-semibold">2000</span> kcal</span>
                        </div>
                        <div class="mt-1 w-full progress-bar-bg rounded-full h-6 overflow-hidden">
                            <div id="calorieProgress" class="progress-bar bg-green-500 h-6 rounded-full leading-6">0%</div>
                        </div>
                        <div class="text-right text-xs text-gray-600 mt-1">Remaining: <span id="remainingCalories" class="font-semibold">2000</span> kcal</div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm font-medium text-gray-700 mb-1">
                            <span>Protein</span>
                            <span>Consumed: <span id="totalProtein" class="font-semibold">0</span> / <span id="proteinGoalDisplay" class="font-semibold">100</span> g</span>
                        </div>
                        <div class="mt-1 w-full progress-bar-bg rounded-full h-6 overflow-hidden">
                            <div id="proteinProgress" class="progress-bar bg-blue-500 h-6 rounded-full leading-6">0%</div>
                        </div>
                        <div class="text-right text-xs text-gray-600 mt-1">Remaining: <span id="remainingProtein" class="font-semibold">100</span> g</div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm font-medium text-gray-700 mb-1">
                            <span>Fiber</span>
                            <span>Consumed: <span id="totalFiber" class="font-semibold">0</span> / <span id="fiberGoalDisplay" class="font-semibold">30</span> g</span>
                        </div>
                        <div class="mt-1 w-full progress-bar-bg rounded-full h-6 overflow-hidden">
                            <div id="fiberProgress" class="progress-bar bg-yellow-500 h-6 rounded-full leading-6">0%</div>
                        </div>
                        <div class="text-right text-xs text-gray-600 mt-1">Remaining: <span id="remainingFiber" class="font-semibold">30</span> g</div>
                    </div>
                </div>
            </section>
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-semibold mb-4 text-indigo-600">Logged Food Items for <span id="logDateDisplay">...</span></h3>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Food</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calories</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Protein (g)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fiber (g)</th><th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th></tr></thead><tbody id="foodLogTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </section>
        </main>

        <main id="calendarView" class="space-y-6" style="display: none;">
            <section class="bg-white p-6 rounded-xl shadow-lg">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-2">
                    <div class="flex space-x-2 mb-2 sm:mb-0">
                        <button id="calendarMonthViewBtn" class="cal-view-btn py-2 px-4 rounded-md font-semibold">Month</button>
                        <button id="calendarWeekViewBtn" class="cal-view-btn py-2 px-4 rounded-md font-semibold bg-gray-200 text-gray-700">Week</button>
                    </div>
                    <h2 id="calendarHeaderDisplay" class="text-xl font-semibold text-indigo-600 order-first sm:order-none mb-2 sm:mb-0 text-center">Month Year</h2>
                    <div class="flex space-x-2">
                        <button id="calendarPrevBtn" class="cal-nav-btn py-2 px-4 rounded-md bg-gray-300 hover:bg-gray-400">&lt; Prev</button>
                        <button id="calendarTodayBtn" class="cal-nav-btn py-2 px-4 rounded-md bg-gray-300 hover:bg-gray-400">Today</button>
                        <button id="calendarNextBtn" class="cal-nav-btn py-2 px-4 rounded-md bg-gray-300 hover:bg-gray-400">Next &gt;</button>
                    </div>
                </div>
                <div id="calendarGridContainer">
                    <div id="calendarGrid" class="bg-gray-200 border border-gray-200">
                        </div>
                </div>
            </section>
        </main>

        <main id="settingsView" class="space-y-6" style="display: none;">
            <section class="bg-white p-6 rounded-xl shadow-lg"><h2 class="text-2xl font-semibold mb-6 text-indigo-600">Daily Goals</h2><form id="settingsForm" class="space-y-6"><div><label for="calorieGoalInput" class="block text-sm font-medium text-gray-700">Daily Calorie Goal (kcal)</label><input type="number" id="calorieGoalInput" name="calorieGoalInput" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="proteinGoalInput" class="block text-sm font-medium text-gray-700">Daily Protein Goal (g)</label><input type="number" id="proteinGoalInput" name="proteinGoalInput" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><div><label for="fiberGoalInput" class="block text-sm font-medium text-gray-700">Daily Fiber Goal (g)</label><input type="number" id="fiberGoalInput" name="fiberGoalInput" min="0" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></div><button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Save Goals</button></form></section>
        </main>

        <footer class="mt-12 text-center text-sm text-gray-500"><p>&copy; <span id="currentYear"></span> Calorie Tracker. All rights reserved.</p><script>document.getElementById('currentYear').textContent = new Date().getFullYear();</script></footer>
    </div>

    <script type="module">
        // --- App State ---
        let currentView = 'dashboard';
        let dailyGoals = { calories: 2000, protein: 100, fiber: 30 };
        let foodLog = [];
        let currentDate = new Date().toISOString().split('T')[0];

        let calendarDisplayDate = new Date();
        let calendarMode = 'month';
        const todayString = new Date().toISOString().split('T')[0];

        // --- LocalStorage Keys ---
        const GOALS_STORAGE_KEY = 'calorieTrackerGoals';
        const FOOD_LOG_STORAGE_KEY_PREFIX = 'calorieTrackerFoodLog_';

        // --- UI Elements ---
        const dashboardView = document.getElementById('dashboardView');
        const calendarView = document.getElementById('calendarView');
        const settingsView = document.getElementById('settingsView');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const messageModal = document.getElementById('messageModal');
        const messageText = document.getElementById('messageText');
        const messageOkButton = document.getElementById('messageOkButton');

        const currentDateDisplay = document.getElementById('currentDateDisplay');
        const addFoodButtonDate = document.getElementById('addFoodButtonDate');
        const progressDateDisplay = document.getElementById('progressDateDisplay');
        const logDateDisplay = document.getElementById('logDateDisplay');

        const foodForm = document.getElementById('foodForm');
        const foodNameInput = document.getElementById('foodName');
        const caloriesInput = document.getElementById('calories');
        const proteinInput = document.getElementById('protein');
        const fiberInput = document.getElementById('fiber');
        const foodLogTableBody = document.getElementById('foodLogTableBody');

        const totalCaloriesDisplay = document.getElementById('totalCalories');
        const totalProteinDisplay = document.getElementById('totalProtein');
        const totalFiberDisplay = document.getElementById('totalFiber');
        const calorieGoalDisplay = document.getElementById('calorieGoalDisplay');
        const proteinGoalDisplay = document.getElementById('proteinGoalDisplay');
        const fiberGoalDisplay = document.getElementById('fiberGoalDisplay');
        const calorieProgress = document.getElementById('calorieProgress');
        const proteinProgress = document.getElementById('proteinProgress');
        const fiberProgress = document.getElementById('fiberProgress');
        const remainingCalories = document.getElementById('remainingCalories');
        const remainingProtein = document.getElementById('remainingProtein');
        const remainingFiber = document.getElementById('remainingFiber');


        const calorieGoalInput = document.getElementById('calorieGoalInput');
        const proteinGoalInput = document.getElementById('proteinGoalInput');
        const fiberGoalInput = document.getElementById('fiberGoalInput');
        const settingsForm = document.getElementById('settingsForm');

        const viewDashboardButton = document.getElementById('viewDashboardButton');
        const viewCalendarButton = document.getElementById('viewCalendarButton');
        const viewSettingsButton = document.getElementById('viewSettingsButton');

        const calendarMonthViewBtn = document.getElementById('calendarMonthViewBtn');
        const calendarWeekViewBtn = document.getElementById('calendarWeekViewBtn');
        const calendarHeaderDisplay = document.getElementById('calendarHeaderDisplay');
        const calendarPrevBtn = document.getElementById('calendarPrevBtn');
        const calendarTodayBtn = document.getElementById('calendarTodayBtn');
        const calendarNextBtn = document.getElementById('calendarNextBtn');
        const calendarGridContainer = document.getElementById('calendarGridContainer');
        const calendarGrid = document.getElementById('calendarGrid');

        // --- Utility Functions ---
        function showLoading(show) { loadingOverlay.style.display = show ? 'flex' : 'none'; }
        function showMessage(message) { messageText.textContent = message; messageModal.classList.remove('hidden'); }
        function hideMessage() { messageModal.classList.add('hidden'); }
        function formatDateToYyyyMmDd(dateObj) { return dateObj.toISOString().split('T')[0]; }

        // --- LocalStorage Functions ---
        function loadGoalsFromLocalStorage() {
            showLoading(true);
            try {
                const storedGoals = localStorage.getItem(GOALS_STORAGE_KEY);
                if (storedGoals) { dailyGoals = JSON.parse(storedGoals); }
            } catch (error) { console.error("Error loading goals:", error); showMessage("Could not load goals."); dailyGoals = { calories: 2000, protein: 100, fiber: 30 };}
            updateSettingsForm();
            showLoading(false);
        }
        function saveGoalsToLocalStorage() {
            showLoading(true);
            try { localStorage.setItem(GOALS_STORAGE_KEY, JSON.stringify(dailyGoals)); showMessage("Goals updated!"); }
            catch (error) { console.error("Error saving goals:", error); showMessage(`Error saving goals: ${error.message}`); }
            updateDashboardSummary();
            if(currentView === 'calendar') renderCalendar();
            showLoading(false);
        }
        function getFoodLogStorageKey(dateString) { return `${FOOD_LOG_STORAGE_KEY_PREFIX}${dateString}`; }

        function loadFoodLogForDateFromLocalStorage(dateString) {
            showLoading(true);
            const storageKey = getFoodLogStorageKey(dateString);
            try {
                const storedFoodLog = localStorage.getItem(storageKey);
                foodLog = storedFoodLog ? JSON.parse(storedFoodLog) : [];
            } catch (error) { console.error(`Error loading food log for ${dateString}:`, error); foodLog = []; }
            renderFoodLog();
            updateDashboardSummary();
            showLoading(false);
        }

        function getDailyTotalsForDate(dateString) {
            const storageKey = getFoodLogStorageKey(dateString);
            let dailyFoodLog = [];
            try {
                const storedFoodLog = localStorage.getItem(storageKey);
                if (storedFoodLog) { dailyFoodLog = JSON.parse(storedFoodLog); }
            } catch (error) { console.error(`Error loading food log for ${dateString} (calendar):`, error); }
            let totals = { calories: 0, protein: 0, fiber: 0 };
            dailyFoodLog.forEach(item => {
                totals.calories += Number(item.calories) || 0;
                totals.protein += Number(item.protein) || 0;
                totals.fiber += Number(item.fiber) || 0;
            });
            return totals;
        }

        function saveFoodLogToLocalStorage(dateString, currentDayFoodLog) {
            const storageKey = getFoodLogStorageKey(dateString);
            try { localStorage.setItem(storageKey, JSON.stringify(currentDayFoodLog)); }
            catch (error) { console.error(`Error saving food log for ${dateString}:`, error); showMessage(`Error saving food log: ${error.message}`);}
        }

        function addFoodItemToLocalStorage(foodItem) {
            showLoading(true);
            const newItem = { ...foodItem, id: Date.now().toString() };
            let currentDayLog = [];
            const storageKey = getFoodLogStorageKey(currentDate);
            try {
                const stored = localStorage.getItem(storageKey);
                if(stored) currentDayLog = JSON.parse(stored);
            } catch (e) { console.error("Error reading log before adding:", e); }

            currentDayLog.push(newItem);
            saveFoodLogToLocalStorage(currentDate, currentDayLog);

            foodLog = currentDayLog;
            renderFoodLog();
            updateDashboardSummary();
            if (currentView === 'calendar') renderCalendar();
            showLoading(false);
        }

        function deleteFoodItemFromLocalStorage(foodItemId) {
            showLoading(true);
            let currentDayLog = [];
            const storageKey = getFoodLogStorageKey(currentDate);
            try {
                const stored = localStorage.getItem(storageKey);
                if(stored) currentDayLog = JSON.parse(stored);
            } catch (e) { console.error("Error reading log before deleting:", e); showLoading(false); return; }

            currentDayLog = currentDayLog.filter(item => item.id !== foodItemId);
            saveFoodLogToLocalStorage(currentDate, currentDayLog);

            foodLog = currentDayLog;
            renderFoodLog();
            updateDashboardSummary();
            if (currentView === 'calendar') renderCalendar();
            console.log("Food item deleted:", foodItemId);
            showLoading(false);
        }

        // --- Calendar Functions ---
        function updateCalendarHeaderDisplay() {
            const options = calendarMode === 'month'
                ? { month: 'long', year: 'numeric' }
                : { month: 'short', day: 'numeric', year: 'numeric' };
            let headerText;
            if (calendarMode === 'month') {
                headerText = calendarDisplayDate.toLocaleDateString(undefined, options);
            } else {
                const startOfWeekForDisplay = new Date(calendarDisplayDate);
                const endOfWeekForDisplay = new Date(startOfWeekForDisplay);
                endOfWeekForDisplay.setDate(startOfWeekForDisplay.getDate() + 6);
                const startText = startOfWeekForDisplay.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                const endText = endOfWeekForDisplay.toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' });
                headerText = `${startText} - ${endText}`;
            }
            calendarHeaderDisplay.textContent = headerText;
        }

        function renderCalendar() {
            showLoading(true);
            calendarGrid.innerHTML = '';
            const existingHeaders = calendarGridContainer.querySelector('.calendar-day-headers-row');
            if (existingHeaders) existingHeaders.remove();

            updateCalendarHeaderDisplay();
            calendarGrid.classList.remove('grid', 'grid-cols-7', 'gap-px', 'calendar-month-view', 'calendar-week-view');

            if (calendarMode === 'month') {
                calendarGrid.classList.add('grid', 'grid-cols-7', 'gap-px', 'calendar-month-view');
                const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const headerRow = document.createElement('div');
                headerRow.className = 'grid grid-cols-7 gap-px calendar-day-headers-row';
                daysOfWeek.forEach(day => {
                    const th = document.createElement('div');
                    th.className = 'calendar-day-header-label p-2 text-center';
                    th.textContent = day;
                    headerRow.appendChild(th);
                });
                calendarGridContainer.insertBefore(headerRow, calendarGrid);
                renderMonthGrid();
            } else {
                calendarGrid.classList.add('calendar-week-view');
                renderWeekGrid();
            }
            showLoading(false);
        }

        function renderMonthGrid() {
            const year = calendarDisplayDate.getFullYear();
            const month = calendarDisplayDate.getMonth();

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDayOfWeek = firstDayOfMonth.getDay();

            for (let i = 0; i < startingDayOfWeek; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell other-month bg-gray-50';
                calendarGrid.appendChild(cell);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                const cellDateString = formatDateToYyyyMmDd(cellDate);

                cell.className = 'calendar-day-cell flex flex-col items-center justify-start';
                if (cellDateString === todayString) cell.classList.add('is-today');
                if (cellDateString === currentDate) cell.classList.add('is-current-dashboard-date');

                const dayNumber = document.createElement('span');
                dayNumber.textContent = day;
                dayNumber.className = 'text-sm font-medium';
                cell.appendChild(dayNumber);

                const dailyTotals = getDailyTotalsForDate(cellDateString);

                const calDisplay = document.createElement('span');
                calDisplay.innerHTML = `<span class="cal-data-value">${dailyTotals.calories}</span> kcal`;
                calDisplay.className = 'cal-data cal-data-cal';
                cell.appendChild(calDisplay);

                const protDisplay = document.createElement('span');
                protDisplay.innerHTML = `<span class="cal-data-value">${dailyTotals.protein}</span> g P`;
                protDisplay.className = 'cal-data cal-data-prot';
                cell.appendChild(protDisplay);

                const fibDisplay = document.createElement('span');
                fibDisplay.innerHTML = `<span class="cal-data-value">${dailyTotals.fiber}</span> g F`;
                fibDisplay.className = 'cal-data cal-data-fib';
                cell.appendChild(fibDisplay);

                cell.onclick = () => {
                    currentDate = cellDateString;
                    loadFoodLogForDateFromLocalStorage(currentDate);
                    updateDashboardDateDisplays();
                    switchView('dashboard');
                };
                calendarGrid.appendChild(cell);
            }
            const totalCells = startingDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell other-month bg-gray-50';
                calendarGrid.appendChild(cell);
            }
        }

        function renderWeekGrid() {
            const startOfWeek = new Date(calendarDisplayDate);

            for (let i = 0; i < 7; i++) {
                const dayInWeek = new Date(startOfWeek);
                dayInWeek.setDate(startOfWeek.getDate() + i);
                const cellDateString = formatDateToYyyyMmDd(dayInWeek);

                const cell = document.createElement('div');
                cell.className = 'calendar-day-cell';
                if (cellDateString === todayString) cell.classList.add('is-today');
                if (cellDateString === currentDate) cell.classList.add('is-current-dashboard-date');

                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'week-view-cell-content';

                const dayInfo = document.createElement('div');
                dayInfo.className = 'week-view-day-info';
                dayInfo.textContent = dayInWeek.toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
                contentWrapper.appendChild(dayInfo);

                const statsDiv = document.createElement('div');
                statsDiv.className = 'week-view-stats';
                const dailyTotals = getDailyTotalsForDate(cellDateString);

                statsDiv.innerHTML = `
                    <span class="cal-data cal-data-cal"><span class="cal-data-value">${dailyTotals.calories}</span> kcal</span>
                    <span class="cal-data cal-data-prot ml-2"><span class="cal-data-value">${dailyTotals.protein}</span> g P</span>
                    <span class="cal-data cal-data-fib ml-2"><span class="cal-data-value">${dailyTotals.fiber}</span> g F</span>
                `;
                contentWrapper.appendChild(statsDiv);
                cell.appendChild(contentWrapper);

                cell.onclick = () => {
                    currentDate = cellDateString;
                    loadFoodLogForDateFromLocalStorage(currentDate);
                    updateDashboardDateDisplays();
                    switchView('dashboard');
                };
                calendarGrid.appendChild(cell);
            }
        }

        // --- UI Update Functions ---
        function updateDashboardDateDisplays() {
            let displayDateStr = "Today";
            try {
                const [year, month, day] = currentDate.split('-').map(Number);
                displayDateStr = new Date(year, month - 1, day).toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                console.error("Invalid currentDate for formatting:", currentDate, e);
                displayDateStr = new Date().toLocaleDateString(undefined, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            }
            currentDateDisplay.textContent = `Displaying: ${displayDateStr}`;
            addFoodButtonDate.textContent = displayDateStr;
            progressDateDisplay.textContent = displayDateStr;
            logDateDisplay.textContent = displayDateStr;
        }

        function switchView(view) {
            currentView = view;
            dashboardView.style.display = view === 'dashboard' ? 'block' : 'none';
            calendarView.style.display = view === 'calendar' ? 'block' : 'none';
            settingsView.style.display = view === 'settings' ? 'block' : 'none';

            viewDashboardButton.classList.toggle('bg-indigo-700', view === 'dashboard');
            viewDashboardButton.classList.toggle('text-white', view === 'dashboard');
            viewDashboardButton.classList.toggle('bg-gray-200', view !== 'dashboard');
            viewDashboardButton.classList.toggle('text-gray-700', view !== 'dashboard');

            viewCalendarButton.classList.toggle('bg-indigo-700', view === 'calendar');
            viewCalendarButton.classList.toggle('text-white', view === 'calendar');
            viewCalendarButton.classList.toggle('bg-gray-200', view !== 'calendar');
            viewCalendarButton.classList.toggle('text-gray-700', view !== 'calendar');

            viewSettingsButton.classList.toggle('bg-indigo-700', view === 'settings');
            viewSettingsButton.classList.toggle('text-white', view === 'settings');
            viewSettingsButton.classList.toggle('bg-gray-200', view !== 'settings');
            viewSettingsButton.classList.toggle('text-gray-700', view !== 'settings');

            if (view === 'settings') {
                updateSettingsForm();
            } else if (view === 'dashboard') {
                updateDashboardDateDisplays();
                loadFoodLogForDateFromLocalStorage(currentDate);
            } else if (view === 'calendar') {
                const [year, monthStr, dayStr] = currentDate.split('-');
                calendarDisplayDate = new Date(Number(year), Number(monthStr) - 1, Number(dayStr));
                if (calendarMode === 'week') {
                    const dayOfWeek = calendarDisplayDate.getDay();
                    calendarDisplayDate.setDate(calendarDisplayDate.getDate() - dayOfWeek);
                }
                renderCalendar();
            }
        }

        function updateSettingsForm() {
            calorieGoalInput.value = dailyGoals.calories; proteinGoalInput.value = dailyGoals.protein; fiberGoalInput.value = dailyGoals.fiber;
        }
        function renderFoodLog() {
            foodLogTableBody.innerHTML = '';
            if (foodLog.length === 0) { const row = foodLogTableBody.insertRow(); const cell = row.insertCell(); cell.colSpan = 5; cell.textContent = 'No food items logged for this day.'; cell.className = 'text-center py-4 text-gray-500'; return; }
            foodLog.forEach(item => { const row = foodLogTableBody.insertRow(); row.insertCell().textContent = item.name; row.insertCell().textContent = item.calories; row.insertCell().textContent = item.protein; row.insertCell().textContent = item.fiber; const deleteButton = document.createElement('button'); deleteButton.textContent = 'Delete'; deleteButton.className = 'px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs'; deleteButton.onclick = () => deleteFoodItemFromLocalStorage(item.id); const actionsCell = row.insertCell(); actionsCell.appendChild(deleteButton); });
        }

        function updateDashboardSummary() {
            let totalCals = 0, totalProt = 0, totalFib = 0;
            foodLog.forEach(item => {
                totalCals += Number(item.calories) || 0;
                totalProt += Number(item.protein) || 0;
                totalFib += Number(item.fiber) || 0;
            });
            totalCaloriesDisplay.textContent = totalCals;
            totalProteinDisplay.textContent = totalProt;
            totalFiberDisplay.textContent = totalFib;

            calorieGoalDisplay.textContent = dailyGoals.calories;
            proteinGoalDisplay.textContent = dailyGoals.protein;
            fiberGoalDisplay.textContent = dailyGoals.fiber;

            const calPercent = dailyGoals.calories > 0 ? Math.min((totalCals / dailyGoals.calories) * 100, 100) : 0;
            const protPercent = dailyGoals.protein > 0 ? Math.min((totalProt / dailyGoals.protein) * 100, 100) : 0;
            const fibPercent = dailyGoals.fiber > 0 ? Math.min((totalFib / dailyGoals.fiber) * 100, 100) : 0;

            calorieProgress.style.width = `${calPercent}%`;
            calorieProgress.textContent = `${Math.round(calPercent)}%`;
            proteinProgress.style.width = `${protPercent}%`;
            proteinProgress.textContent = `${Math.round(protPercent)}%`;
            fiberProgress.style.width = `${fibPercent}%`;
            fiberProgress.textContent = `${Math.round(fibPercent)}%`;

            remainingCalories.textContent = Math.max(0, dailyGoals.calories - totalCals);
            remainingProtein.textContent = Math.max(0, dailyGoals.protein - totalProt);
            remainingFiber.textContent = Math.max(0, dailyGoals.fiber - totalFib);
        }

        // --- Event Handlers ---
        foodForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newFood = {
                name: foodNameInput.value.trim(),
                calories: parseInt(caloriesInput.value) || 0,
                protein: parseInt(proteinInput.value) || 0,
                fiber: parseInt(fiberInput.value) || 0,
            };
            if (!newFood.name) { showMessage("Please enter a food name."); return; }
            addFoodItemToLocalStorage(newFood);
            foodForm.reset();
        });

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            dailyGoals.calories = parseInt(calorieGoalInput.value) || 0;
            dailyGoals.protein = parseInt(proteinGoalInput.value) || 0;
            dailyGoals.fiber = parseInt(fiberGoalInput.value) || 0;
            saveGoalsToLocalStorage();
        });

        viewDashboardButton.addEventListener('click', () => switchView('dashboard'));
        viewCalendarButton.addEventListener('click', () => switchView('calendar'));
        viewSettingsButton.addEventListener('click', () => switchView('settings'));
        messageOkButton.addEventListener('click', hideMessage);

        calendarMonthViewBtn.addEventListener('click', () => {
            calendarMode = 'month';
            calendarMonthViewBtn.classList.add('bg-indigo-700', 'text-white');
            calendarMonthViewBtn.classList.remove('bg-gray-200', 'text-gray-700');
            calendarWeekViewBtn.classList.add('bg-gray-200', 'text-gray-700');
            calendarWeekViewBtn.classList.remove('bg-indigo-700', 'text-white');
            const [year, monthStr, dayStr] = currentDate.split('-');
            calendarDisplayDate = new Date(Number(year), Number(monthStr) - 1, Number(dayStr));
            renderCalendar();
        });
        calendarWeekViewBtn.addEventListener('click', () => {
            calendarMode = 'week';
            calendarWeekViewBtn.classList.add('bg-indigo-700', 'text-white');
            calendarWeekViewBtn.classList.remove('bg-gray-200', 'text-gray-700');
            calendarMonthViewBtn.classList.add('bg-gray-200', 'text-gray-700');
            calendarMonthViewBtn.classList.remove('bg-indigo-700', 'text-white');

            const [year, monthStr, dayStr] = currentDate.split('-');
            calendarDisplayDate = new Date(Number(year), Number(monthStr) - 1, Number(dayStr));
            const dayOfWeek = calendarDisplayDate.getDay();
            calendarDisplayDate.setDate(calendarDisplayDate.getDate() - dayOfWeek);
            renderCalendar();
        });

        calendarPrevBtn.addEventListener('click', () => {
            if (calendarMode === 'month') {
                calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() - 1);
            } else {
                calendarDisplayDate.setDate(calendarDisplayDate.getDate() - 7);
            }
            renderCalendar();
        });
        calendarNextBtn.addEventListener('click', () => {
            if (calendarMode === 'month') {
                calendarDisplayDate.setMonth(calendarDisplayDate.getMonth() + 1);
            } else {
                calendarDisplayDate.setDate(calendarDisplayDate.getDate() + 7);
            }
            renderCalendar();
        });
        calendarTodayBtn.addEventListener('click', () => {
            calendarDisplayDate = new Date();
             if (calendarMode === 'week') {
                const dayOfWeek = calendarDisplayDate.getDay();
                calendarDisplayDate.setDate(calendarDisplayDate.getDate() - dayOfWeek);
            }
            renderCalendar();
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadGoalsFromLocalStorage();
            loadFoodLogForDateFromLocalStorage(currentDate);

            updateDashboardDateDisplays();
            switchView('dashboard');
            updateSettingsForm();
        });
    </script>
</body>
</html>
